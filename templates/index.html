<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title>Disease Research Trends</title>
	<link type="text/css" rel="stylesheet" href="{{ url_for('bower.static', filename='materialize/bin/materialize.css') }}" media="screen,projection" />
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<style>
		.axis path, .axis line {
			fill: none;
			stroke: black;
			shape-rendering: crispEdges;
		}

		.axis text {
			font-family: sans-serif;
			font-size: 11px;
		}

		#yearChart .bar {
			fill: #F44336;
			stroke: #000000;
			shape-rendering: crispEdges;
		}
	</style>
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>
<body>
	<main>
		<div class="section red lighten" id="index-banner">
			<div class="container">
				<div class="row">
					<div class="col s12">
						<h1 class="header white-text">Disease Research Trends</h1>
					</div>
				</div>
			</div>
		</div>
		<div class="container">
			<div class="section">
				<h5>Search for a disease or disease area</h5>
				<div class="row">
					<form class="col l6 m12" action="{{ url_for('search') }}" method="POST">
						<div class="row">
							<div class="input-field col s12">
								<i class="material-icons prefix">search</i>
								<input type="text" id="search_term" name="search_term">
								<label for="search_term">Search</label>
							</div>
						</div>
						<div class="row">
							<div class="input-field col s6">
								<input type="text" id="search_start" name="search_start">
								<label for="search_start">Start Year</label>
							</div>
							<div class="input-field col s6">
								<input type="text" id="search_end" name="search_end">
								<label for="search_end">End Year</label>
							</div>
						</div>
						<div class="progress hide" id="search_in_progress">
							<div class="indeterminate"></div>
						</div>
					</form>
					<div class="col l6 m12">
						<div class="card blue-grey darken-1">
							<div class="card-content white-text">
								<p>eg Diabetes, Coronary Heart Disease</p>
								<p>Optionally, enter a start or end year for the search</p>
								<p>Press enter to submit your search</p>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="divider"></div>
			<div class="section">
				<h5>Research articles per year</h5>
				<div class="col m12" id="yearChart"></div>
			</div>
			<div class="divider"></div>
			<div class="section">
				<h5>Author Frequency</h5>
			</div>

			<div class="row">
				<div class="col s12" id="query_details">
				</div>
			</div>

		</div>
	</main>


	<script type="text/javascript" src="{{ url_for('bower.static', filename='jquery/dist/jquery.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('bower.static', filename='materialize/bin/materialize.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('bower.static', filename='d3/d3.min.js') }}"></script>
	<script type="text/javascript">
		function drawYearGraph(data) {
			$("#yearChart").empty();
			var margin = {
				top: 20,
				right: 20,
				bottom: 20,
				left: 60
			};
			var width = $("#yearChart").width() - margin.left - margin.right;
			var height = 600 - margin.top - margin.bottom;
			var xScale = d3.scale.ordinal().rangeRoundBands([0, width], 0.1);
			var yScale = d3.scale.linear().rangeRound([height, 0]);
			var xAxis = d3.svg.axis().scale(xScale).orient("bottom");
			var yAxis = d3.svg.axis().scale(yScale).orient("left").tickFormat(d3.format("d"));
			var svg = d3.select("#yearChart")
					.append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)
					.append("g")
					.attr("transform", "translate(" + margin.left + ", " + margin.top + ")");
			xScale.domain(data.map(function (d){ return d["year"]}));
			yScale.domain([0, d3.max(data, function(d) { return d["articles"]})]);
			var num_ticks = xScale.domain().length;
			var new_ticks = [];
			$.each(xScale.domain(), function (index, tick){
				var spacing = 5;
				if (num_ticks > 100) {
					spacing = 10;
				}
				if (tick % spacing == 0) {
					new_ticks.push(tick)
				}
			});
			xAxis.tickValues(new_ticks);
			svg.append("g").attr("class", "x axis").attr("transform", "translate(0, " + height + ")").call(xAxis);
			svg.append("g").attr("class", "y axis").call(yAxis);
			svg.selectAll("rect")
					.data(data, function(d){return d["year"]})
					.enter()
					.append("rect")
					.attr("x", function(d){ return xScale(d["year"])})
					.attr("y", function(d){ return yScale(d["articles"])})
					.attr("width", xScale.rangeBand())
					.attr("height", function (d) { return yScale(0) - yScale(d["articles"])})
					.attr("class", "bar");
		}

		$(document).on("keypress", "input", function(e){
			if (e.which==13) {
				// Enter key
				e.preventDefault();  // Don't submit conventionally
				var form = $(this).parents("form");
				var form_data = form.serializeArray();
				var form_target = form.attr("action");
				$.ajax({
					url: form_target,
					method: "POST",
					data: form_data,
					dataType: "json"
				}).success(function(data){
					drawYearGraph(data["articlesPerYear"]);
					$("#query_details").html(data["queryDetails"]);
				}).always(function(){
					$("#search_in_progress").addClass("hide");
				});
				$("#search_in_progress").removeClass("hide");
			}
		})
	</script>
</body>
</html>